# BINDINGS #

set -g mode-keys vi

%if "$SSH_CONNECTION"
  set -g prefix C-b
  bind C-b send-prefix
%elif "$CONTAINER"
  set -g prefix C-a
  bind C-a send-prefix
%else
  set -g prefix C-Space
  bind C-Space send-prefix
%endif

unbind -qa -T root
unbind -qa -T prefix
unbind -qa -T copy-mode
unbind -qa -T copy-mode-vi

bind    -T prefix       !       break-pane
bind    -T prefix       ,       command-prompt -I "#W" { rename-window "%%" }
bind    -T prefix       :       command-prompt
bind    -T prefix       \'      split-window -v -c "#{pane_current_path}"
bind    -T prefix       \"      split-window -h -c "#{pane_current_path}"
bind    -T prefix       ?       list-keys
bind    -T prefix       [       copy-mode
bind    -T prefix       ]       paste-buffer -p
bind    -T prefix       0       select-window -t :=0
bind    -T prefix       1       select-window -t :=1
bind    -T prefix       2       select-window -t :=2
bind    -T prefix       3       select-window -t :=3
bind    -T prefix       4       select-window -t :=4
bind    -T prefix       5       select-window -t :=5
bind    -T prefix       6       select-window -t :=6
bind    -T prefix       7       select-window -t :=7
bind    -T prefix       8       select-window -t :=8
bind    -T prefix       9       select-window -t :=9
bind    -T prefix       C       customize-mode
bind    -T prefix       D       display-panes
bind    -T prefix       H       next-window
bind    -T prefix       L       previous-window
bind    -T prefix       M       select-pane -M
bind    -T prefix       c       new-window
bind    -T prefix       d       detach-client
bind -r -T prefix       h       select-pane -L
bind -r -T prefix       j       select-pane -D
bind -r -T prefix       k       select-pane -U
bind -r -T prefix       l       select-pane -R
bind    -T prefix       m       select-pane -m
bind    -T prefix       r       refresh-client
bind    -T prefix       p       run-shell "tmux-ai prompt"
bind    -T prefix       s       swap-pane
bind    -T prefix       t       choose-tree -w
bind    -T prefix       w       clock-mode
bind    -T prefix       x       confirm-before -y -p "kill-pane #P? (Y/n)" kill-pane
bind    -T prefix       z       resize-pane -Z
bind    -T prefix       C-Space send-prefix
bind -r -T prefix       C-h     resize-pane -L 5
bind -r -T prefix       C-j     resize-pane -D 5
bind -r -T prefix       C-k     resize-pane -U 5
bind -r -T prefix       C-l     resize-pane -R 5
bind -r -T prefix       M-h     resize-pane -L
bind -r -T prefix       M-j     resize-pane -D
bind -r -T prefix       M-k     resize-pane -U
bind -r -T prefix       M-l     resize-pane -R
bind    -T copy-mode-vi Enter   send -X copy-selection-and-cancel
bind    -T copy-mode-vi Escape  send -X clear-selection
bind    -T copy-mode-vi \%      send -X next-matching-bracket
bind    -T copy-mode-vi \$      send -X end-of-line
bind    -T copy-mode-vi ^       send -X back-to-indentation
bind    -T copy-mode-vi ?       command-prompt -T search -p "(search up)" { send-keys -X search-backward "%%" }
bind    -T copy-mode-vi /       command-prompt -T search -p "(search down)" { send-keys -X search-forward "%%" }
bind    -T copy-mode-vi 0       send -X start-of-line
bind    -T copy-mode-vi G       send -X history-bottom
bind    -T copy-mode-vi J       send -X scroll-down
bind    -T copy-mode-vi K       send -X scroll-up
bind    -T copy-mode-vi V       send -X select-line
bind    -T copy-mode-vi e       send -X copy-pipe-no-clear "tmux-ai explain"
bind    -T copy-mode-vi g       send -X history-top
bind    -T copy-mode-vi h       send -X cursor-left
bind    -T copy-mode-vi j       send -X cursor-down
bind    -T copy-mode-vi k       send -X cursor-up
bind    -T copy-mode-vi l       send -X cursor-right
bind    -T copy-mode-vi n       send -X search-again
bind    -T copy-mode-vi p       send -X search-reverse
bind    -T copy-mode-vi q       send -X cancel
bind    -T copy-mode-vi r       send -X rectangle-toggle
bind    -T copy-mode-vi v       send -X begin-selection
bind    -T copy-mode-vi w       send -X next-word
bind    -T copy-mode-vi x       send -X select-line
bind    -T copy-mode-vi y       send -X copy-selection
bind    -T copy-mode-vi z       send -X scroll-middle
bind    -T copy-mode-vi C-d     send -X halfpage-down
bind    -T copy-mode-vi C-u     send -X halfpage-up

bind -T prefix S display-menu -T "Layout Picker" \
  'Even Horizontal'          0 'selectl even-horizontal' \
  'Even Vertical'            1 'selectl even-vertical' \
  'Main Horizontal'          2 'selectl main-horizontal' \
  'Main Horizontal Mirrored' 3 'selectl main-horizontal-mirrored' \
  'Main Vertical'            4 'selectl main-vertical' \
  'Main Vertical Mirrored'   5 'selectl main-vertical-mirrored' \
  'Tiled'                    5 'selectl tiled' \

# STYLES #

set -g pane-active-border-style fg=blue

# Window status bar
%if "$SSH_CONNECTION"
  set -g pane-active-border-style fg=green
  set -g status-style 'fg=black,align=centre,bg=lightgreen'
  set -g status-right '#(hostname)'
%elif "$CONTAINER"
  set -g pane-active-border-style fg=yellow
  set -g status-style 'fg=black,align=centre,bg=yellow'
  set -g status-right '#(hostname)'
%else
  set -g pane-active-border-style fg=blue
  set -g status-style 'fg=black,align=centre,bg=lightblue'
  set -g status-right '%a %Y-%m-%d %H:%M'
%endif

set -g status-justify               "absolute-centre"
set -g status-left-length           "40"
set -g status-left                  "[#{session_name}/#{window_index}/#{pane_index}]"
set -g window-status-separator      " │ "
set -g window-status-format         " #{window_index}: #{window_name} "
set -g window-status-current-format ">#{window_index}: #{window_name}<"
set -g message-style                "bg=lightyellow"

# Pane status bar
set -g pane-border-status top
set -g pane-border-format "┤#{?pane_active,#[reverse],} #{pane_title} #[default]├"

# TWEAKS #

set -ga terminal-features ",alacritty*:usstyle"

# Allow inner tmux to set clipboard and buffers.
set -g set-clipboard "on"

set -g escape-time      "0"
set -g repeat-time      "250"
set -g default-terminal "tmux-256color"

# Keyboards start with 1 and numbering must be consistent.
set -g base-index       "1"
set -g pane-base-index  "1"
set -g renumber-windows "on"

# When a pane fails, keep it open to inspect the error.
set -g remain-on-exit failed

set -g history-limit 50000


# LOCAL #

source -q ~/.config/tmux/local.conf
